<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chicken Road ‚Äì Mini Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #263057 0, #050712 60%, #020307 100%);
      color: #f4f7ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .game-shell {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(145deg, rgba(19, 25, 48, 0.97), rgba(9, 13, 31, 0.97));
      border-radius: 20px;
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      padding: 20px 22px 26px;
      position: relative;
      overflow: hidden;
    }

    .game-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(
        from 270deg,
        rgba(0, 255, 163, 0.08),
        transparent,
        rgba(0, 153, 255, 0.12),
        transparent,
        rgba(255, 220, 0, 0.14),
        transparent
      );
      filter: blur(38px);
      opacity: 0.7;
      pointer-events: none;
    }

    .game-shell-inner {
      position: relative;
      z-index: 1;
    }

    header.game-header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
      margin-bottom: 18px;
    }

    .title-block h1 {
      font-size: 1.5rem;
      letter-spacing: 0.02em;
    }

    .title-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(17, 255, 160, 0.1);
      border: 1px solid rgba(17, 255, 160, 0.3);
      font-size: 0.76rem;
      margin-top: 4px;
    }

    .title-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #11ffa0;
      box-shadow: 0 0 8px #11ffa0;
    }

    .balance-block {
      text-align: right;
      font-size: 0.9rem;
    }

    .balance-label {
      opacity: 0.7;
      font-size: 0.78rem;
    }

    .balance-value {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 3px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
      gap: 18px;
    }

    /* BOARD SIDE */

    .board-card {
      background: radial-gradient(circle at top, #222a4a 0, #090d1e 55%);
      border-radius: 18px;
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
      box-shadow:
        0 16px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(255, 255, 255, 0.02);
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .board-header h2 {
      font-size: 0.98rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .multiplier-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .multiplier-value {
      font-weight: 600;
      font-size: 1rem;
    }

    .board-subline {
      font-size: 0.76rem;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .road-wrapper {
      position: relative;
      border-radius: 14px;
      background: #0a0e1d;
      padding: 14px 12px 11px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .road-sheen {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.08) 0,
          transparent 35%,
          transparent 65%,
          rgba(255, 255, 255, 0.08) 100%
      );
      mix-blend-mode: soft-light;
      opacity: 0.3;
      pointer-events: none;
    }

    .road-lanes {
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.5) 0,
          rgba(0, 0, 0, 0.5) 18px,
          rgba(255, 255, 255, 0.2) 19px,
          rgba(255, 255, 255, 0.2) 20px
        );
      opacity: 0.14;
      pointer-events: none;
    }

    /* Cars */

    .car {
      position: absolute;
      width: 52px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff3b6b, #ffb347);
      box-shadow: 0 0 14px rgba(255, 80, 120, 0.8);
      top: 14%;
      animation: car-drive 4.4s linear infinite;
    }

    .car::before,
    .car::after {
      content: "";
      position: absolute;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #000;
      bottom: -4px;
      box-shadow: 26px 0 0 #000;
    }

    .car:nth-of-type(2) {
      top: 48%;
      width: 58px;
      height: 22px;
      background: linear-gradient(135deg, #63b3ff, #11ffa0);
      box-shadow: 0 0 14px rgba(80, 200, 255, 0.8);
      animation-duration: 5.2s;
      animation-delay: -1.6s;
    }

    .car:nth-of-type(3) {
      top: 82%;
      width: 46px;
      height: 19px;
      background: linear-gradient(135deg, #ffd54a, #ff6f00);
      box-shadow: 0 0 14px rgba(255, 213, 74, 0.8);
      animation-duration: 3.9s;
      animation-delay: -3s;
    }

    @keyframes car-drive {
      0% {
        transform: translateX(-110%);
      }
      100% {
        transform: translateX(140%);
      }
    }

    /* Grid */

    .grid {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      gap: 6px;
      padding: 6px;
    }

    .tile {
      position: relative;
      padding-bottom: 90%;
      border-radius: 10px;
      background: radial-gradient(circle at top, #1b243f 0, #050814 70%);
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      overflow: hidden;
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        background 0.15s ease-out,
        border-color 0.15s ease-out;
    }

    .tile::after {
      content: attr(data-step);
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.6rem;
      opacity: 0.4;
    }

    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.05),
        0 8px 18px rgba(0, 0, 0, 0.8);
    }

    .tile.visited {
      background: radial-gradient(circle at top, #182b3b 0, #050814 80%);
      border-color: rgba(90, 191, 255, 0.6);
      box-shadow:
        0 0 0 1px rgba(90, 191, 255, 0.5),
        0 0 20px rgba(90, 191, 255, 0.4);
    }

    .tile.safe {
      background: radial-gradient(circle at top, #1c3f2b 0, #050814 80%);
      border-color: rgba(17, 255, 160, 0.7);
      box-shadow:
        0 0 0 1px rgba(17, 255, 160, 0.6),
        0 0 22px rgba(17, 255, 160, 0.55);
    }

    .tile.hazard,
    .tile.reveal-hazard {
      background: radial-gradient(circle at top, #4b1119 0, #050814 80%);
      border-color: rgba(255, 92, 117, 0.7);
      box-shadow:
        0 0 0 1px rgba(255, 92, 117, 0.6),
        0 0 22px rgba(255, 92, 117, 0.6);
    }

    .tile.active {
      transform: translateY(-2px);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.2),
        0 14px 26px rgba(0, 0, 0, 0.9);
    }

    .tile.jump {
      animation: tile-pop 0.22s ease-out;
    }

    @keyframes tile-pop {
      0% {
        transform: translateY(0) scale(1);
      }
      40% {
        transform: translateY(-4px) scale(1.04);
      }
      100% {
        transform: translateY(-2px) scale(1);
      }
    }

    /* Chicken */

    .chicken {
      position: absolute;
      inset: 14% 14% 14% 14%;
      border-radius: 999px;
      background: radial-gradient(circle at 28% 24%, #ffeaa7 0, #fbc531 40%, #e1b12c 70%, #c27c3b 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.8),
        0 0 12px rgba(255, 224, 130, 0.85);
      animation: chicken-bob 0.9s ease-in-out infinite;
      transform-origin: center;
    }

    .chicken::after {
      content: "üêî";
      transform: translateY(-2px);
    }

    .chicken.dead {
      animation: chicken-squash 0.5s forwards;
    }

    @keyframes chicken-bob {
      0%,
      100% {
        transform: translateY(0) scale(1);
      }
      50% {
        transform: translateY(-3px) scale(1.03);
      }
    }

    @keyframes chicken-squash {
      0% {
        transform: translateY(0) scale(1);
        filter: brightness(1);
      }
      60% {
        transform: translateY(6px) scale(1.1, 0.7);
        filter: brightness(1.2);
      }
      100% {
        transform: translateY(10px) scale(1.2, 0.4);
        filter: grayscale(0.7) brightness(0.6);
      }
    }

    .status-line {
      margin-top: 10px;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .status-text {
      opacity: 0.78;
    }

    .status-text[data-tone="win"] {
      color: #11ffa0;
      opacity: 1;
    }

    .status-text[data-tone="loss"] {
      color: #ff6b81;
      opacity: 1;
    }

    .mini-meta {
      font-size: 0.7rem;
      opacity: 0.6;
    }

    /* CONTROL SIDE */

    .control-card {
      background: radial-gradient(circle at top, #1a2343 0, #050814 70%);
      border-radius: 18px;
      padding: 14px 14px 16px;
      box-shadow:
        0 16px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(255, 255, 255, 0.02);
    }

    .control-card h2 {
      font-size: 0.96rem;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .form-row {
      margin-bottom: 10px;
    }

    .form-row.double {
      display: grid;
      grid-template-columns: 1.2fr 1.4fr;
      gap: 10px;
    }

    .label {
      font-size: 0.76rem;
      opacity: 0.75;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .label span.badge {
      font-size: 0.68rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    input,
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(3, 6, 20, 0.9);
      color: #f4f7ff;
      font-size: 0.86rem;
      outline: none;
      transition:
        border-color 0.12s ease-out,
        box-shadow 0.12s ease-out,
        background 0.12s ease-out;
    }

    input:focus,
    select:focus {
      border-color: rgba(90, 191, 255, 0.9);
      box-shadow:
        0 0 0 1px rgba(90, 191, 255, 0.7),
        0 0 18px rgba(90, 191, 255, 0.45);
      background: rgba(3, 8, 26, 0.98);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .button-row {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    button {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        background 0.15s ease-out,
        opacity 0.12s ease-out;
      white-space: nowrap;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #11ffa0, #47c9ff);
      color: #020412;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 12px 22px rgba(10, 255, 180, 0.35);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 16px 30px rgba(10, 255, 206, 0.45);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff5a7c, #ffb347);
      color: #050312;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 12px 22px rgba(255, 120, 120, 0.45);
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 16px 30px rgba(255, 120, 120, 0.6);
    }

    .btn-ghost {
      background: rgba(3, 5, 15, 0.9);
      color: #f4f7ff;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 8px 20px rgba(0, 0, 0, 0.85);
    }

    .btn-ghost:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.12),
        0 12px 26px rgba(0, 0, 0, 0.95);
      background: rgba(7, 9, 22, 0.98);
    }

    .btn-ghost span.pip {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #11ffa0;
      box-shadow: 0 0 10px rgba(17, 255, 160, 0.7);
    }

    .cashout-note {
      font-size: 0.76rem;
      opacity: 0.75;
    }

    .cashout-note strong {
      color: #11ffa0;
    }

    .auto-toggle-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .auto-toggle-row input[type="checkbox"] {
      width: auto;
      accent-color: #11ffa0;
      cursor: pointer;
    }

    .auto-settings {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px dashed rgba(255, 255, 255, 0.18);
      display: none;
    }

    .auto-settings-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    .tiny-label {
      font-size: 0.72rem;
      opacity: 0.7;
      margin-bottom: 2px;
    }

    .rtp-line {
      margin-top: 8px;
      font-size: 0.74rem;
      opacity: 0.8;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .rtp-pill {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.35);
      font-size: 0.7rem;
    }

    .helper-line {
      margin-top: 8px;
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .helper-line strong {
      color: #ffdf6b;
      font-weight: 500;
    }

    .helper-line span.dot {
      display: inline-block;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #11ffa0;
      box-shadow: 0 0 6px rgba(17, 255, 160, 0.8);
      margin-right: 4px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .board-card {
        order: -1;
      }

      header.game-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .balance-block {
        text-align: left;
      }
    }
  </style>
</head>
<body>
<div class="game-shell">
  <div class="game-shell-inner">
    <header class="game-header">
      <div class="title-block">
        <h1>Chicken Road</h1>
        <div class="title-pill">
          <span class="dot"></span>
          <span>Provably-random demo ¬∑ No real money</span>
        </div>
      </div>
      <div class="balance-block">
        <div class="balance-label">Demo Balance</div>
        <div class="balance-value"><span id="balance">1000.00</span> credits</div>
      </div>
    </header>

    <div class="layout">
      <!-- BOARD -->
      <section class="board-card">
        <div class="board-header">
          <h2>Cross the road, dodge the chaos</h2>
          <div class="multiplier-chip">
            <span>Current multiplier</span>
            <span class="multiplier-value" id="multiplier">1.00x</span>
          </div>
        </div>
        <div class="board-subline">
          Each jump raises the multiplier <strong>and</strong> the risk. Cash out before your chicken gets flattened.
        </div>
        <div class="road-wrapper">
          <div class="road-sheen"></div>
          <div class="road-lanes"></div>
          <div class="car"></div>
          <div class="car"></div>
          <div class="car"></div>

          <div class="grid" id="grid"></div>
        </div>

        <div class="status-line">
          <div class="status-text" id="status" data-tone="">
            Place a bet, pick a difficulty, then hit <strong>Bet &amp; Jump</strong>.
          </div>
          <div class="mini-meta">
            Potential win: <strong><span id="potentialWin">0.00</span></strong>
          </div>
        </div>
      </section>

      <!-- CONTROLS -->
      <section class="control-card">
        <h2>Bet Controls</h2>

        <div class="form-row double">
          <div>
            <div class="label">
              <span>Stake</span>
              <span class="badge">Demo credits</span>
            </div>
            <input id="bet" type="number" min="1" step="1" value="25" />
          </div>
          <div>
            <div class="label">
              <span>Difficulty</span>
              <span class="badge">Volatility</span>
            </div>
            <select id="difficulty">
              <option value="easy">Easy ¬∑ Low risk</option>
              <option value="medium">Normal ¬∑ Balanced</option>
              <option value="hard">Hard ¬∑ High risk</option>
              <option value="insane">Insane ¬∑ Extreme</option>
            </select>
          </div>
        </div>

        <div class="button-row">
          <button id="startBtn" class="btn-primary">
            <span>Bet &amp; Jump</span>
          </button>
          <button id="cashoutBtn" class="btn-danger" disabled>
            <span>Cash Out</span>
          </button>
        </div>

        <div class="form-row">
          <button id="jumpBtn" class="btn-ghost" disabled>
            <span class="pip"></span>
            <span>Manual Jump</span>
          </button>
        </div>

        <div class="cashout-note">
          Cash out pays: <strong>stake √ó tile multiplier</strong>. If the chicken hits a broken tile, you lose the stake for this round.
        </div>

        <div class="auto-toggle-row">
          <input id="autoToggle" type="checkbox" />
          <label for="autoToggle">Enable Auto Mode (auto jumps &amp; auto cashout)</label>
        </div>

        <div class="auto-settings" id="autoSettings">
          <div class="auto-settings-row">
            <div>
              <div class="tiny-label">Max jumps per round</div>
              <input id="autoJumps" type="number" min="1" max="10" step="1" value="4" />
            </div>
            <div>
              <div class="tiny-label">Delay between jumps (ms)</div>
              <input id="autoDelay" type="number" min="300" max="2000" step="50" value="800" />
            </div>
          </div>
          <div class="tiny-label">
            Auto mode will keep jumping until it reaches the max jumps or your chicken crashes. If it survives the last jump, it auto cashes out.
          </div>
        </div>

        <div class="rtp-line">
          <span>Simulated RTP (long-term): <strong>98.00%</strong></span>
          <span class="rtp-pill">House edge ~2%</span>
        </div>

        <div class="helper-line">
          <span class="dot"></span>
          <strong>Tip:</strong> Use easier modes to build balance, then take shots on higher multipliers. Always play with a budget.
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // --- Simple synth music (looping 8-bit style) ---
  let audioCtx = null;
  let bgGain = null;
  let musicStarted = false;

  function startBgm() {
    if (musicStarted) return;
    musicStarted = true;

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;

    audioCtx = new AudioContext();
    bgGain = audioCtx.createGain();
    bgGain.gain.value = 0.06;
    bgGain.connect(audioCtx.destination);

    const notes = [
      261.63, 293.66, 329.63, 392.0,
      392.0, 349.23, 329.63, 293.66,
      261.63, 196.0, 220.0, 246.94
    ];

    let idx = 0;

    function scheduleNote() {
      if (!audioCtx || audioCtx.state === "closed") return;

      const osc = audioCtx.createOscillator();
      osc.type = "square";
      osc.frequency.value = notes[idx % notes.length];

      const noteGain = audioCtx.createGain();
      noteGain.gain.setValueAtTime(0, audioCtx.currentTime);
      noteGain.gain.linearRampToValueAtTime(0.9, audioCtx.currentTime + 0.01);
      noteGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

      osc.connect(noteGain);
      noteGain.connect(bgGain);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.32);

      idx++;
      setTimeout(scheduleNote, 340);
    }

    scheduleNote();
  }

  // --- Game logic ---
  document.addEventListener("DOMContentLoaded", () => {
    const COLS = 10;

    const gridEl = document.getElementById("grid");
    const multiplierEl = document.getElementById("multiplier");
    const statusEl = document.getElementById("status");
    const balanceEl = document.getElementById("balance");
    const potentialWinEl = document.getElementById("potentialWin");
    const betInput = document.getElementById("bet");
    const difficultySelect = document.getElementById("difficulty");
    const startBtn = document.getElementById("startBtn");
    const jumpBtn = document.getElementById("jumpBtn");
    const cashoutBtn = document.getElementById("cashoutBtn");
    const autoToggle = document.getElementById("autoToggle");
    const autoSettings = document.getElementById("autoSettings");
    const autoJumpsInput = document.getElementById("autoJumps");
    const autoDelayInput = document.getElementById("autoDelay");

    const chicken = document.createElement("div");
    chicken.className = "chicken";

    const CONFIG = {
      easy: {
        hazardChance: 0.18,
        multipliers: [1.1, 1.2, 1.35, 1.55, 1.8, 2.1, 2.5, 3.0, 3.8, 4.8]
      },
      medium: {
        hazardChance: 0.25,
        multipliers: [1.1, 1.25, 1.5, 1.9, 2.4, 3.0, 3.8, 4.9, 6.5, 8.5]
      },
      hard: {
        hazardChance: 0.33,
        multipliers: [1.2, 1.4, 1.8, 2.4, 3.3, 4.5, 6.0, 8.0, 11.0, 15.0]
      },
      insane: {
        hazardChance: 0.45,
        multipliers: [1.3, 1.7, 2.3, 3.2, 4.6, 6.5, 9.0, 13.0, 18.0, 25.0]
      }
    };

    let tiles = [];
    let state = {
      balance: 1000,
      running: false,
      currentIndex: -1,
      hazardMap: [],
      currentMultiplier: 1.0,
      stake: 0,
      autoTimer: null,
      crashed: false
    };

    function buildGrid() {
      gridEl.innerHTML = "";
      tiles = [];
      for (let c = 0; c < COLS; c++) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.index = c.toString();
        tile.dataset.step = (c + 1).toString();
        gridEl.appendChild(tile);
        tiles.push(tile);
      }
    }

    function updateBalance() {
      balanceEl.textContent = state.balance.toFixed(2);
    }

    function updatePotentialWin() {
      const potential = state.stake * state.currentMultiplier;
      if (!isFinite(potential)) {
        potentialWinEl.textContent = "0.00";
      } else {
        potentialWinEl.textContent = potential.toFixed(2);
      }
      multiplierEl.textContent = state.currentMultiplier.toFixed(2) + "x";
    }

    function updateStatus(message, tone) {
      statusEl.textContent = message;
      statusEl.dataset.tone = tone || "";
    }

    function resetRoundUI() {
      tiles.forEach((t) => {
        t.className = "tile";
      });
      if (chicken.parentElement) {
        chicken.parentElement.removeChild(chicken);
      }
      chicken.classList.remove("dead");
    }

    function generateHazards() {
      const diff = difficultySelect.value;
      const hazardChance = CONFIG[diff].hazardChance;
      const map = new Array(COLS).fill(false);
      for (let i = 0; i < COLS; i++) {
        if (i === 0) continue; // first tile always safe
        map[i] = Math.random() < hazardChance;
      }
      state.hazardMap = map;
    }

    function clearAutoTimer() {
      if (state.autoTimer) {
        clearInterval(state.autoTimer);
        state.autoTimer = null;
      }
    }

    function startRound() {
      if (state.running) return;

      const betValue = parseFloat(betInput.value);
      if (isNaN(betValue) || betValue <= 0) {
        alert("Please enter a valid stake greater than 0.");
        return;
      }
      if (betValue > state.balance) {
        alert("Not enough demo balance for this stake.");
        return;
      }

      // Start music on first user game action
      startBgm();

      state.balance -= betValue;
      state.stake = betValue;
      updateBalance();

      resetRoundUI();
      generateHazards();

      const diff = difficultySelect.value;
      state.currentIndex = 0;
      state.currentMultiplier = CONFIG[diff].multipliers[0] || 1.1;
      state.running = true;
      state.crashed = false;

      const firstTile = tiles[0];
      firstTile.classList.add("active", "safe");
      firstTile.appendChild(chicken);

      updatePotentialWin();
      updateStatus("Round live! Jump forward or cash out any time.", "");

      startBtn.disabled = true;
      jumpBtn.disabled = false;
      cashoutBtn.disabled = false;
    }

    function handleCrash() {
      state.running = false;
      state.crashed = true;
      chicken.classList.add("dead");

      tiles.forEach((tile, idx) => {
        if (state.hazardMap[idx]) {
          tile.classList.add("reveal-hazard");
        }
      });

      clearAutoTimer();
      startBtn.disabled = false;
      jumpBtn.disabled = true;
      cashoutBtn.disabled = true;

      updateStatus("Oh no! The chicken got squashed. Stake lost this round.", "loss");
    }

    function jumpForward() {
      if (!state.running) return;

      const nextIndex = state.currentIndex + 1;

      // If we moved beyond the last tile, auto cashout at final multiplier
      if (nextIndex >= COLS) {
        cashOut();
        return;
      }

      const prevTile = tiles[state.currentIndex];
      prevTile.classList.remove("active");
      prevTile.classList.add("visited");

      state.currentIndex = nextIndex;
      const currentTile = tiles[nextIndex];
      currentTile.classList.add("active", "jump");

      // Move chicken
      currentTile.appendChild(chicken);

      // Calculate new multiplier
      const diff = difficultySelect.value;
      const cfg = CONFIG[diff];
      const nextMult = cfg.multipliers[nextIndex] || cfg.multipliers[cfg.multipliers.length - 1];
      state.currentMultiplier = nextMult;
      updatePotentialWin();

      // Check hazard
      const isHazard = state.hazardMap[nextIndex];
      if (isHazard) {
        currentTile.classList.add("hazard");
        handleCrash();
      } else {
        currentTile.classList.add("safe");
        updateStatus("Safe tile! Jump again or cash out your current win.", "");
      }
    }

    function cashOut() {
      if (!state.running) return;

      const win = state.stake * state.currentMultiplier;
      state.balance += win;
      state.running = false;

      updateBalance();
      clearAutoTimer();

      startBtn.disabled = false;
      jumpBtn.disabled = true;
      cashoutBtn.disabled = true;

      updateStatus(
        "You cashed out for " + win.toFixed(2) + " credits. Nice timing!",
        "win"
      );
    }

    function startAutoMode() {
      const maxJumps = parseInt(autoJumpsInput.value, 10) || 4;
      const delay = parseInt(autoDelayInput.value, 10) || 800;

      let jumpsDone = 0;
      clearAutoTimer();

      state.autoTimer = setInterval(() => {
        if (!state.running) {
          clearAutoTimer();
          return;
        }

        jumpsDone += 1;

        if (jumpsDone >= maxJumps) {
          // final jump or immediate cashout if we already exceeded
          if (jumpsDone === maxJumps) {
            jumpForward();
            if (state.running) {
              cashOut();
            }
          }
          clearAutoTimer();
          return;
        } else {
          jumpForward();
        }
      }, delay);
    }

    // --- Event wiring ---

    startBtn.addEventListener("click", () => {
      startRound();

      if (autoToggle.checked && state.running) {
        startAutoMode();
      }
    });

    jumpBtn.addEventListener("click", () => {
      jumpForward();
    });

    cashoutBtn.addEventListener("click", () => {
      cashOut();
    });

    autoToggle.addEventListener("change", () => {
      autoSettings.style.display = autoToggle.checked ? "block" : "none";
      if (!autoToggle.checked) {
        clearAutoTimer();
      }
    });

    // Basic state init
    buildGrid();
    state.currentMultiplier = 1.0;
    updateBalance();
    updatePotentialWin();
  });
</script>
</body>
</html>
